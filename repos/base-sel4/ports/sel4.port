LICENSE   := GPLv2
VERSION   := git
DOWNLOADS := sel4.git

URL(sel4) := https://github.com/lulu98/seL4.git
# master branch, version 9.0.1
# Basic Port - 32-bit
REV(sel4) := 4d41314d6bdbd49a133361c2ab48eef992e4f680
# GIC-PL390 - 32-bit
# REV(sel4) := 24143a45fb2876733214fa5ee66627bf402a4440
# GIC-400 - 32-bit
# REV(sel4) := fdfc129844bc0d635e57e4c086e714e47e75e583
# Legacy IC - 32-bit
# REV(sel4) := 90241edcd989b6f7feee9e2a97266f227fd973b4
# ARMv7a - 32-bit
# REV(sel4) := e4ea781e6fe137a84706606ee54a3f1e1384c919
DIR(sel4) := src/kernel/sel4

$(call check_tool,python)
$(call check_python_module,future)
$(call check_python_module,tempita)
$(call check_python_module,ply)
$(call check_python_module,six)

PATCHES   := $(sort $(wildcard $(REP_DIR)/patches/*.patch))

HASH_INPUT += $(REP_DIR)/patches/imx6q_sabrelite.config
HASH_INPUT += $(REP_DIR)/patches/imx7d_sabre.config
HASH_INPUT += $(REP_DIR)/patches/rpi3.config
HASH_INPUT += $(REP_DIR)/patches/rpi4.config

# adjust kernel config usable on qemu and on native hw, and add a 32bit version
default: $(DOWNLOADS)
	$(VERBOSE)mkdir -p src/kernel/sel4/configs/pc99/x86_64
	$(VERBOSE)mkdir -p src/kernel/sel4/configs/pc99/ia32
	$(VERBOSE)cp src/kernel/sel4/configs/pc99/autoconf.h src/kernel/sel4/configs/pc99/x86_64/autoconf.h
	$(VERBOSE)mv src/kernel/sel4/configs/pc99/autoconf.h src/kernel/sel4/configs/pc99/ia32/autoconf.h
	$(VERBOSE)sed -i "s.^ \*/. \*/\n#ifndef ARCH_IA32\n#define ARCH_IA32\n#endif\n." src/kernel/sel4/configs/pc99/ia32/autoconf.h
	$(VERBOSE)mkdir -p src/kernel/sel4/configs/imx6/imx6q_sabrelite
	$(VERBOSE)mv src/kernel/sel4/configs/imx6/autoconf.h src/kernel/sel4/configs/imx6/imx6q_sabrelite/autoconf.h
	$(VERBOSE)patch -p0 <$(REP_DIR)/patches/imx6q_sabrelite.config
	$(VERBOSE)mkdir -p src/kernel/sel4/configs/imx7/imx7d_sabre
	$(VERBOSE)mv src/kernel/sel4/configs/imx7/autoconf.h src/kernel/sel4/configs/imx7/imx7d_sabre/autoconf.h
	$(VERBOSE)patch -p0 <$(REP_DIR)/patches/imx7d_sabre.config
	$(VERBOSE)mkdir -p src/kernel/sel4/configs/bcm2837/rpi3
	$(VERBOSE)mv src/kernel/sel4/configs/bcm2837/autoconf.h src/kernel/sel4/configs/bcm2837/rpi3/autoconf.h
	$(VERBOSE)patch -p0 <$(REP_DIR)/patches/rpi3.config
	$(VERBOSE)mkdir -p src/kernel/sel4/configs/bcm2711/rpi4
	$(VERBOSE)mv src/kernel/sel4/configs/bcm2711/autoconf.h src/kernel/sel4/configs/bcm2711/rpi4/autoconf.h
	$(VERBOSE)patch -p0 <$(REP_DIR)/patches/rpi4.config
